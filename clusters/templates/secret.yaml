{{- $existing := lookup "v1" "Secret" .Release.Namespace (printf "%s-cluster-secret" .Release.Name) }}
{{- if not $existing }}
{{- $password := .Values.password | default (randAlphaNum 24) }}
apiVersion: v1
type: kubernetes.io/basic-auth
metadata:
  name: {{ .Release.Name }}-cluster-secret
data:
  dbname: {{ "app" | b64enc }}
  host: {{ .Values.ingress.host | b64enc }}
  jdbc-uri: >-
    {{ printf "jdbc:postgresql://%s:5432/app?password=%s&user=app" .Values.host $password | b64enc }}
  password: {{ $password | b64enc }}
  pgpass: {{ printf "%s:%s:app:app:%s" .Values.host (default "5432" .Values.port) $password | b64enc }}
  port: {{ "5432" | b64enc }}
  uri: >-
    {{ printf "postgresql://app:%s@%s:5432/app" $password .Values.host | b64enc }}
  user: {{ "app" | b64enc }}
  username: {{ "app" | b64enc }}
{{- end }}
